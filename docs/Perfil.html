<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ConoCEU Â· Perfil</title>
  <link rel="stylesheet" href="css/perfil.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Gochi+Hand&display=swap" rel="stylesheet">
</head>
<body>
  <div class="app-frame">
    <!-- Barra superior -->
    <header class="topbar">
      <div class="window-dots">
        <span></span><span></span><span></span>
      </div>

      <a href="index.html" class="brand">
        <span class="brand-primary">Cono</span><span class="brand-accent">CEU</span>
      </a>

      <div class="top-actions">
        <a href="Chats.html" class="icon-btn" aria-label="Chats" title="Chats">
          <img src="img/Chats.png" alt="" class="icon">
        </a>
        <a href="Notificaciones.html" class="icon-btn" aria-label="Notificaciones" title="Notificaciones">
          <img src="img/Campanita.png" alt="" class="icon">
        </a>
        <a href="Perfil.html" class="icon-btn" aria-label="Perfil" title="Perfil">
          <img src="img/Perfil.png" alt="" class="icon">
        </a>
      </div>
    </header>

    <!-- TÃ­tulo -->
    <div class="page-title">Perfil</div>

    <!-- Layout -->
    <main class="layout">
      <!-- Columna izquierda -->
      <aside class="col-left">
        <section class="card info-card">
          <h3>InformaciÃ³n</h3>

          <dl class="info-grid">
            <div>
              <dt>Usuario</dt>
              <dd id="profile-username">@usuarioCEU</dd>
            </div>
            <div>
              <dt>Nombre</dt>
              <dd id="profile-name">Nombre Apellidos</dd>
            </div>
            <div>
              <dt>Grado</dt>
              <dd id="profile-degree">Ing. Sistemas de InformaciÃ³n</dd>
            </div>
            <div>
              <dt>Curso</dt>
              <dd id="profile-year">3Âº</dd>
            </div>
            <div>
              <dt>Email</dt>
              <dd id="profile-email">usuario@ceu.es</dd>
            </div>
            <div>
              <dt>PaÃ­s</dt>
              <dd id="profile-country">EspaÃ±a</dd>
            </div>
            <div>
              <dt>Ciudad</dt>
              <dd id="profile-city">Madrid</dd>
            </div>
          </dl>

          <div class="intereses">
            <h4>Intereses</h4>
            <div class="chips" id="profile-interests">
              <span class="chip">TecnologÃ­a</span>
              <span class="chip">Deporte</span>
              <span class="chip">MÃºsica</span>
            </div>
          </div>
        </section>
      </aside>

      <!-- Columna central -->
      <section class="col-center">
        <div class="card profile-header">
          <div class="avatar" aria-hidden="true" id="profile-avatar">
            Foto<br>placeholder
          </div>

          <div class="profile-meta">
            <h2 id="profile-fullname">Nombre Apellidos</h2>
            <p class="subtitle" id="profile-subtitle">Estudiante CEU Â· Madrid</p>

            <div class="profile-actions">
              <button class="btn btn-primary">Enviar mensaje</button>
              <button class="btn">Editar perfil</button>
              <button class="btn btn-ghost">Compartir</button>
              <button class="btn btn-ghost" id="logout-btn">Cerrar sesiÃ³n</button>
            </div>

            <nav class="tabs">
              <button class="tab active">Publicaciones</button>
              <button class="tab">Tienda</button>
              <button class="tab">Chats</button>
              <button class="tab">Info</button>
            </nav>
          </div>
        </div>

        <!-- Publicaciones (por ahora estÃ¡tico) -->
        <article class="card post">
          <h4>Apuntes de Sistemas</h4>
          <div class="post-meta">hoy Â· #IS Â· 3Âº</div>
          <p>Comparto resumen de la unidad 2. Â¡Ã‰xitos!</p>
          <div class="post-actions">
            <span>ðŸ”¥ 12</span>
            <span>ðŸ’¬ 3</span>
            <a href="#" class="link">ðŸ”— Compartir</a>
          </div>
        </article>

        <article class="card post">
          <h4>Club de running CEU</h4>
          <div class="post-meta">ayer Â· #deporte</div>
          <p>Salimos los jueves 19:00 desde Moncloa. Â¡Ãšnete!</p>
          <div class="post-actions">
            <span>ðŸ”¥ 7</span>
            <span>ðŸ‘€ 1</span>
          </div>
        </article>
      </section>

      <!-- Columna derecha: anuncio con video local -->
      <aside class="col-right">
        <div class="ad video-container">
          <video
            src="anuncios/AnuncioAdidas.mp4"
            autoplay
            muted
            loop
            playsinline
            preload="auto"
            controlslist="nodownload noplaybackrate"
            disablepictureinpicture
            oncontextmenu="return false;"
          ></video>
        </div>
      </aside>
    </main>

    <!-- Engranaje -->
    <button class="gear" aria-label="Ajustes" title="Ajustes">
      <svg viewBox="0 0 24 24" width="28" height="28" aria-hidden="true">
        <path d="M19.14 12.94a7.43 7.43 0 0 0 0-1.88l2.03-1.58a.5.5 0 0 0 .12-.64l-1.92-3.32a.5.5 0 0 0-.6-.23l-2.39.96a7.36 7.36 0 0 0-1.63-.95l-.36-2.55a.5.5 0 0 0-.5-.42h-3.84a.5.5 0 0 0-.5.42l-.36 2.55c-.57.23-1.12.54-1.63.95l-2.39-.96a.5.5 0 0 0-.6.23L2.71 8.84a.5.5 0 0 0 .12.64l2.03 1.58a7.43 7.43 0 0 0 0 1.88l-2.03 1.58a.5.5 0 0 0-.12.64l1.92 3.32c.13.22.39.31.6.23l2.39-.96c.51.41 1.06.72 1.63.95l.36 2.55c.05.24.26.42.5.42h3.84c.24 0 .45-.18.5-.42l.36-2.55c.57-.23 1.12-.54 1.63-.95l2.39.96c.21.08.47-.01.6-.23l1.92-3.32a.5.5 0 0 0-.12-.64l-2.03-1.58ZM12 15.5A3.5 3.5 0 1 1 15.5 12 3.5 3.5 0 0 1 12 15.5Z" fill="currentColor"/>
      </svg>
    </button>
  </div>

  <script>
    const API_BASE = 'https://conoceu-backend.onrender.com';

    function redirectToLogin() {
      window.location.href = 'login.html';
    }

    async function cargarPerfil() {
      const token = localStorage.getItem('token');

      if (!token) {
        redirectToLogin();
        return;
      }

      try {
        const res = await fetch(API_BASE + '/api/profile', {
          method: 'GET',
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });

        if (!res.ok) {
          // Token invÃ¡lido, caducado o usuario no encontrado
          localStorage.removeItem('token');
          redirectToLogin();
          return;
        }

        const user = await res.json();

        // Rellenar datos en la UI
        const fullName = (user.nombre || '') + ' ' + (user.apellido || '');
        const subtitleParts = [];
        if (user.grado) subtitleParts.push(user.grado);
        if (user.ciudad) subtitleParts.push(user.ciudad);
        if (user.pais && !subtitleParts.includes(user.pais)) subtitleParts.push(user.pais);

        document.getElementById('profile-username').textContent = user.username ? '@' + user.username : '@usuario';
        document.getElementById('profile-name').textContent = fullName.trim() || 'Nombre Apellidos';
        document.getElementById('profile-fullname').textContent = fullName.trim() || 'Nombre Apellidos';

        document.getElementById('profile-degree').textContent = user.grado || 'Grado no especificado';
        document.getElementById('profile-year').textContent = user.curso || 'â€”';
        document.getElementById('profile-email').textContent = user.email || '';
        document.getElementById('profile-country').textContent = user.pais || 'â€”';
        document.getElementById('profile-city').textContent = user.ciudad || 'â€”';

        document.getElementById('profile-subtitle').textContent =
          subtitleParts.length > 0 ? subtitleParts.join(' Â· ') : 'Estudiante CEU';

        // Si hubiera foto de perfil URL podrÃ­as usarla para fondo o imagen
        if (user.foto_perfil) {
          const avatar = document.getElementById('profile-avatar');
          avatar.style.backgroundImage = 'url(' + user.foto_perfil + ')';
          avatar.style.backgroundSize = 'cover';
          avatar.style.backgroundPosition = 'center';
          avatar.textContent = '';
        }
      } catch (err) {
        console.error('Error cargando perfil', err);
        localStorage.removeItem('token');
        redirectToLogin();
      }
    }

    document.addEventListener('DOMContentLoaded', function () {
      cargarPerfil();

      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', function () {
          localStorage.removeItem('token');
          redirectToLogin();
        });
      }
    });
  </script>
</body>
</html>
