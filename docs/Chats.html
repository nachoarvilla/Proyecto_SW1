<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ConoCEU ‚Äî Chats</title>
  <link rel="stylesheet" href="css/style_chats.css">
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script> 
</head>
<body class="ch-page">
  <header class="ch-header">
    <a href="index.html" class="ch-brand" aria-label="Ir a inicio">
      <span class="ch-brand-cono">Cono</span><span class="ch-brand-ceu">CEU</span>
    </a>
    <div class="nav-center" onclick="location.reload()">
      <h1 class="ch-title">Chats</h1>
      <img src="img/logoceu.png" alt="Logo CEU" class="ch-logo">
    </div>
    <nav class="ch-actions" aria-label="Acciones">
      <a class="ch-iconbtn" aria-label="Chats" href="Chats.html">
        <img src="img/Chats.png" alt="" class="ch-icon">
      </a>
      <a class="ch-iconbtn" href="Notificaciones.html" aria-label="Ir a notificaciones">
        <img src="img/Campanita.png" alt="" class="ch-icon">
      </a>
      <a class="ch-iconbtn" href="Perfil.html" aria-label="Ir a perfil">
        <img src="img/Perfil.png" alt="" class="ch-icon">
      </a>
    </nav>
  </header>

  <main class="ch-layout">
    <aside class="ch-sidebar">
      <div class="ch-tabs" role="tablist" aria-label="Tipo de chat">
        <button class="ch-tab is-active" role="tab" aria-selected="true"
                id="tab-ind" data-target="#list-ind">Individuales</button>
        <button class="ch-tab" role="tab" aria-selected="false"
                id="tab-grp" data-target="#list-grp">Grupales</button>
      </div>

    <div id="list-ind" class="ch-list" role="tabpanel" aria-labelledby="tab-ind">
        <p style="text-align: center; color: var(--muted);" id="loading-ind">Cargando chats...</p>
    </div>

    <div id="list-grp" class="ch-list" role="tabpanel" aria-labelledby="tab-grp" hidden>
        <p style="text-align: center; color: var(--muted);" id="loading-grp">Cargando chats...</p>
    </div>

    <button class="ch-new" type="button" onclick="window.location.href='resultado_usuarios.html'">
      Nuevo chat
    </button>
    </aside>

    <section class="ch-panel" aria-label="Conversaci√≥n">
      <header class="ch-panel-hd">
        <img src="img/Perfil.png" alt="" class="ch-user-avatar" id="chat-header-avatar">
        <div class="ch-user">
          <strong id="chat-header-name">Selecciona un chat</strong>
          <span class="ch-user-status" id="chat-header-status">Desconectado</span>
        </div>
      </header>

      <div class="ch-thread" aria-live="polite" id="chat-thread">
        <p style="text-align: center; color: var(--muted); padding-top: 50px;">
          Haz click en un chat para ver la conversaci√≥n.
        </p>
      </div>

      <form class="ch-input" id="message-form" onsubmit="sendMessage(event)">
        <input type="text" id="message-input" placeholder="Escribe un mensaje..." aria-label="Escribe un mensaje" disabled>
        <button type="submit" id="send-button" disabled>Enviar</button>
      </form>
    </section>
  </main>

  <footer class="ch-footer">
    <small>¬© <span id="year"></span> ConoCEU</small>
  </footer>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

  <script>
    // URL base de tu backend
    const BASE_URL = 'https://conoceu-backend.onrender.com';
    let currentChatId = null;
    let userId = null; 
    let socket = null;

    /* ===================== TEMA GLOBAL (SECCI√ìN NUEVA) ===================== */
    function applyThemePreference(prefFromStorage) {
      const pref = prefFromStorage || localStorage.getItem('cfg_theme') || 'system';

      function setTheme(theme) {
        document.documentElement.dataset.theme = theme;
      }

      if (pref === 'system') {
        const mq = window.matchMedia('(prefers-color-scheme: dark)');
        setTheme(mq.matches ? 'dark' : 'light');
        mq.addEventListener('change', e => {
          const current = localStorage.getItem('cfg_theme') || 'system';
          if (current === 'system') {
            setTheme(e.matches ? 'dark' : 'light');
          }
        });
      } else {
        setTheme(pref);
      }
    }
    
    // üí° Ejecutar inmediatamente para aplicar el tema al cargar la p√°gina
    applyThemePreference(); 
    /* ======================================================================= */

    // --- Utilidades ---
    function getToken() {
      return localStorage.getItem('token');
    }
    
    // Obtener la ID del usuario desde el token (se mantiene)
    function decodeToken() {
        const token = getToken();
        if (!token) return null;
        try {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload).id;
        } catch (e) {
            console.error("Error al decodificar token", e);
            return null;
        }
    }

    // --- Sockets ---

    function setupSocket() {
      const token = getToken();
      userId = decodeToken();
      if (!token || !userId) {
        alert('Necesitas iniciar sesi√≥n para usar el chat.');
        window.location.href = 'Login.html'; // Redirige si no hay token
        return;
      }

      socket = io(BASE_URL, {
        auth: {
          token: token
        },
        transports: ['websocket', 'polling']
      });

      socket.on('connect', () => {
        console.log('Conectado al servidor de sockets.');
        if(currentChatId) {
            socket.emit('chat:join', Number(currentChatId)); // Asegurar Number
        }
      });
      
      socket.on('disconnect', () => {
        console.log('Desconectado del servidor de sockets.');
      });

      socket.on('connect_error', (err) => {
        console.error('Error de conexi√≥n de socket:', err.message);
        alert('Error conectando al servidor de chat. Int√©ntalo de nuevo.');
      });
      
      // üí° EVENTO CLAVE: Recibir mensaje instant√°neo
      socket.on('chat:message', (message) => {
          // CR√çTICO: Usar Number() para la validaci√≥n del chat
          if (Number(message.chat_id) === Number(currentChatId)) {
              displayMessage(message);
          }
      });
    }

    // --- L√≥gica de la Interfaz (Se mantiene) ---
    function createChatListItem(chat) {
        // ... (c√≥digo se mantiene) ...
        const button = document.createElement('button');
        const isActive = chat.id == currentChatId ? ' is-active' : '';
        button.className = 'ch-item' + isActive;
        button.setAttribute('data-chat-id', chat.id);
        button.setAttribute('data-chat-name', chat.nombre);
        
        const avatarSrc = chat.foto_perfil || 'img/Perfil.png';

        button.innerHTML = `
            <img src="${avatarSrc}" alt="" class="ch-item-avatar">
            <span>${chat.nombre}</span>
        `;
        button.addEventListener('click', () => selectChat(chat));
        return button;
    }
    
    function createMessageElement(message) {
        // ... (c√≥digo se mantiene) ...
        const isOut = message.user_id == userId;
        const msgDiv = document.createElement('div');
        msgDiv.className = `msg msg-${isOut ? 'out' : 'in'}`;
        
        const time = new Date(message.fecha_envio).toLocaleTimeString('es-ES', { 
            hour: '2-digit', minute: '2-digit' 
        });

        const senderName = (message.es_grupo && !isOut) ? `<small style="font-weight: bold;">${message.username}:</small><br>` : '';

        msgDiv.innerHTML = `
            <p>${senderName}${message.contenido}</p>
            <time>${time}</time>
        `;
        return msgDiv;
    }
    
    function displayMessage(message) {
        // ... (c√≥digo se mantiene) ...
        const chatThread = document.getElementById('chat-thread');
        const msgElement = createMessageElement(message);
        chatThread.appendChild(msgElement);
        chatThread.scrollTop = chatThread.scrollHeight;
    }
    
    function resetChatPanel(chatName, avatarSrc = 'img/Perfil.png') {
        // ... (c√≥digo se mantiene) ...
        document.getElementById('chat-header-name').textContent = chatName;
        document.getElementById('chat-header-avatar').src = avatarSrc;
        document.getElementById('chat-header-status').textContent = 'Conectado';
        document.getElementById('chat-thread').innerHTML = '<p style="text-align: center; color: var(--muted); padding-top: 50px;">Cargando mensajes...</p>';
        document.getElementById('message-input').disabled = false;
        document.getElementById('send-button').disabled = false;
    }
    
    function disableChatPanel() {
        // ... (c√≥digo se mantiene) ...
        document.getElementById('chat-header-name').textContent = 'Selecciona un chat';
        document.getElementById('chat-header-avatar').src = 'img/Perfil.png';
        document.getElementById('chat-header-status').textContent = 'Desconectado';
        document.getElementById('chat-thread').innerHTML = '<p style="text-align: center; color: var(--muted); padding-top: 50px;">Haz click en un chat para ver la conversaci√≥n.</p>';
        document.getElementById('message-input').disabled = true;
        document.getElementById('send-button').disabled = true;
    }


    // --- Peticiones al Backend (Se mantiene la correcci√≥n anterior) ---

    // 1. Cargar la lista de chats
    async function loadChatList() {
        const listInd = document.getElementById('list-ind');
        const listGrp = document.getElementById('list-grp');
        
        // Establecer los mensajes iniciales (para evitar el error de null si falla)
        listInd.innerHTML = '<p style="text-align: center; color: var(--muted);" id="loading-ind">Cargando chats...</p>';
        listGrp.innerHTML = '<p style="text-align: center; color: var(--muted);" id="loading-grp">Cargando chats...</p>';


        try {
            const response = await fetch(`${BASE_URL}/api/chats`, {
                headers: { 'Authorization': `Bearer ${getToken()}` }
            });

            if (response.status === 401) {
                alert('Sesi√≥n expirada. Por favor, vuelve a iniciar sesi√≥n.');
                window.location.href = 'Login.html';
                return;
            }

            const chats = await response.json();

            // Limpiar el contenido ANTES de empezar a a√±adir los resultados.
            listInd.innerHTML = '';
            listGrp.innerHTML = '';
            
            if (chats.length === 0) {
                listInd.innerHTML = '<p style="text-align: center; color: var(--muted);">No hay chats individuales.</p>';
                listGrp.innerHTML = '<p style="text-align: center; color: var(--muted);">No hay chats grupales.</p>';
            } else {
                chats.forEach(chat => {
                    if (chat.es_grupo) {
                        listGrp.appendChild(createChatListItem(chat));
                    } else {
                        listInd.appendChild(createChatListItem(chat));
                    }
                });
            }
        } catch (error) {
            console.error('Error al cargar chats:', error);
            listInd.innerHTML = '<p style="color:red; text-align: center;">Error al cargar.</p>';
            listGrp.innerHTML = '<p style="color:red; text-align: center;">Error al cargar.</p>';
        }
    }

    // 2. Seleccionar un chat y cargar sus mensajes
    async function selectChat(chat) {
        // ... (c√≥digo se mantiene) ...
        document.querySelectorAll('.ch-item.is-active').forEach(btn => 
            btn.classList.remove('is-active')
        );

        const currentChatButton = document.querySelector(`.ch-item[data-chat-id="${chat.id}"]`);
        if(currentChatButton) {
            currentChatButton.classList.add('is-active');
        }

        currentChatId = chat.id;
        resetChatPanel(chat.nombre, chat.foto_perfil);

        // üí° Unirse a la sala de Socket.io
        if (socket && socket.connected) {
            socket.emit('chat:join', Number(currentChatId));
        }

        try {
            const response = await fetch(`${BASE_URL}/api/chats/${currentChatId}/mensajes?limit=50`, {
                headers: { 'Authorization': `Bearer ${getToken()}` }
            });
            
            if (response.status === 401) {
                alert('Sesi√≥n expirada. Por favor, vuelve a iniciar sesi√≥n.');
                window.location.href = 'Login.html';
                return;
            }

            const messages = await response.json();
            const chatThread = document.getElementById('chat-thread');
            chatThread.innerHTML = ''; 

            if (messages.length === 0) {
                chatThread.innerHTML = '<p style="text-align: center; color: var(--muted); padding-top: 50px;">No hay mensajes a√∫n.</p>';
            } else {
                messages.forEach(msg => displayMessage(msg));
            }

        } catch (error) {
            console.error('Error al cargar mensajes:', error);
            document.getElementById('chat-thread').innerHTML = '<p style="color:red; text-align: center;">Error al cargar mensajes.</p>';
        }
    }
    
    // 3. Enviar mensaje (se mantiene)
    async function sendMessage(event) {
        event.preventDefault();
        
        const input = document.getElementById('message-input');
        const contenido = input.value.trim();
        
        if (!contenido || !currentChatId) return;

        input.value = '';

        try {
            const response = await fetch(`${BASE_URL}/api/chats/${currentChatId}/mensajes`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getToken()}` 
                },
                body: JSON.stringify({ contenido })
            });

            if (response.ok) {
                const now = new Date().toISOString();
                displayMessage({ 
                    contenido, 
                    user_id: userId, 
                    fecha_envio: now 
                });
            } else {
                const error = await response.json();
                alert(`Error al enviar mensaje: ${error.error}`);
                input.value = contenido;
            }

        } catch (error) {
            console.error('Error al enviar mensaje:', error);
            alert('Error de conexi√≥n al enviar mensaje.');
            input.value = contenido;
        }
    }


    // --- Inicializaci√≥n ---

    document.addEventListener('DOMContentLoaded', () => {
        // A√±o en el footer
        document.getElementById('year').textContent = new Date().getFullYear();
        
        // Cargar datos y configurar sockets
        disableChatPanel();
        setupSocket();
        loadChatList();

        // L√≥gica de Tabs (se mantiene)
        const tabs = document.querySelectorAll('.ch-tab');
        const lists = {
            '#list-ind': document.querySelector('#list-ind'),
            '#list-grp': document.querySelector('#list-grp')
        };
        function showList(targetSel){
            Object.values(lists).forEach(el => el.hidden = true);
            const targetEl = lists[targetSel];
            if (targetEl) {
                targetEl.hidden = false;
            }
        }
        tabs.forEach(btn => {
            btn.addEventListener('click', () => {
                tabs.forEach(b => { b.classList.remove('is-active'); b.setAttribute('aria-selected','false'); });
                btn.classList.add('is-active'); btn.setAttribute('aria-selected','true');
                showList(btn.dataset.target);
            });
        });
        showList('#list-ind');
    });

  </script>
</body>
</html>