<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ConoCEU ¬∑ Tienda ExtraEscolar</title>
  <link rel="stylesheet" href="css/style_tienda_extraescolar.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@600;700&display=swap" rel="stylesheet">
</head>
<body>
  <header class="header">
    <nav class="nav">
      <a href="index.html" class="logo">ConoCEU</a>

      <div class="nav-center">
        <img src="img/logoceu.png" alt="Logo CEU" class="logo-ceu">
        <span>Tienda</span>
        <span class="tag-extra" aria-label="Secci√≥n ExtraEscolar">ExtraEscolar</span>
      </div>

      <div class="nav-actions">
        <a class="icon-btn" href="Chats.html" aria-label="Mensajes" title="Mensajes">
          <svg class="icon" viewBox="0 0 24 24"><path d="M21 12a8 8 0 0 1-8 8H7l-4 3 1.5-5A8 8 0 1 1 21 12Z"></path></svg>
        </a>
        <a class="icon-btn" href="Notificaciones.html" aria-label="Notificaciones" title="Notificaciones">
          <svg class="icon" viewBox="0 0 24 24"><path d="M15 17H4l2-3v-4a6 6 0 1 1 12 0v4l2 3h-5"></path></svg>
        </a>
        <a href="Perfil.html" class="icon-btn" aria-label="Perfil" title="Perfil">
          <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="8" r="4"></circle><path d="M4 21a8 8 0 0 1 16 0"></path></svg>
        </a>
      </div>
    </nav>
  </header>

  <main class="wrap">
    
    <aside class="col-side-left">
      <a href="crear_nuevo_producto_extraescolar.html" class="new-post-btn" title="Crear nuevo producto">
        <svg viewBox="0 0 24 24" class="icon">
          <path d="M12 5v14M5 12h14"></path>
        </svg>
        <span>Vender Material</span>
      </a>
    </aside>

    <section class="feed" id="product-feed">
      <p style="text-align:center; color:var(--muted);" id="feed-status">Cargando productos...</p>
    </section>

    <aside class="panel search">
      <h3>Buscar objeto</h3>
      <div class="searchbar">
        <input type="text" placeholder="Buscar objeto (p. ej. 'bal√≥n')" aria-label="Buscar objeto" />
        <span class="magnify" aria-hidden="true">
          <svg class="icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="7"></circle><path d="M21 21l-4-4"></path></svg>
        </span>
      </div>
      <ul class="results">
        <li tabindex="0">Bal√≥n</li>
        <li tabindex="0">Raqueta</li>
        <li tabindex="0">Pinturas</li>
        <li tabindex="0">Cepillo artes</li>
        <li tabindex="0">Zapatillas</li>
        <li tabindex="0">Camiseta equipo</li>
        <li tabindex="0">Sudadera</li>
        <li tabindex="0">Bid√≥n</li>
      </ul>
    </aside>
  </main>

  <dialog id="offerDialog" class="modal">
    <form method="dialog" class="modal-card" id="offerForm" novalidate>
      <h3 class="modal-title">Enviar oferta</h3>
      <div class="modal-subtitle" id="offerItem">Art√≠culo</div>
      <label class="price-label" for="offerInput">Importe (‚Ç¨)</label>
      <div class="price-input">
        <span>‚Ç¨</span>
        <input id="offerInput" name="importe" type="number" min="0.10" step="0.10" inputmode="decimal" required>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn ghost" id="cancelOffer">Cancelar</button>
        <button type="submit" class="btn primary">Confirmar</button>
      </div>
      <div id="offerMsg" class="msg"></div>
    </form>
  </dialog>

  <script>
    const API_BASE = 'https://conoceu-backend.onrender.com';
    const ENDPOINT = '/api/tienda-extraescolar'; // üí° CAMBIO CLAVE: Endpoint de la tienda extraescolar
    let currentProductId = null; 

    // --- Funciones de Tema/Token ---
    function applyThemePreference(prefFromStorage) {
      const pref = prefFromStorage || localStorage.getItem('cfg_theme') || 'system';
      function setTheme(theme) { document.documentElement.dataset.theme = theme; }
      if (pref === 'system') {
        const mq = window.matchMedia('(prefers-color-scheme: dark)');
        setTheme(mq.matches ? 'dark' : 'light');
        mq.addEventListener('change', e => {
          const current = localStorage.getItem('cfg_theme') || 'system';
          if (current === 'system') { setTheme(e.matches ? 'dark' : 'light'); }
        });
      } else { setTheme(pref); }
    }
    
    function getTokenOrRedirect() {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = 'login.html';
        return null;
      }
      return token;
    }

    // --- Renderizado ---
    function createProductCard(item) {
        const date = new Date(item.fecha_creacion).toLocaleDateString('es-ES', { 
            day: 'numeric', month: 'short' 
        });
        const time = new Date(item.fecha_creacion).toLocaleTimeString('es-ES', { 
            hour: '2-digit', minute: '2-digit' 
        });

        const post = document.createElement('article');
        post.className = 'post';
        post.dataset.itemId = item.id;
        post.dataset.itemName = item.descripcion.substring(0, 30); 

        post.innerHTML = `
            <header class="post-head">
                <div class="avatar" aria-hidden="true"></div>
                <div>
                    <div class="username">${item.username}</div>
                    <div class="muted" style="font-size:12px">${item.ubicacion || 'Ubicaci√≥n desconocida'} ¬∑ ${date} ${time}</div>
                </div>
            </header>

            <div class="post-media" aria-label="Imagen del producto">
                <div class="ph">
                    <img src="${item.foto}" alt="${item.descripcion}" onerror="this.onerror=null; this.src='img/placeholder.jpg';" />
                </div>
            </div>

            <div class="product-header">
                <span class="item-name">${item.descripcion.substring(0, 50)}...</span>
                <span class="item-price">PVP: ${parseFloat(item.precio).toFixed(2).replace('.', ',')} ‚Ç¨</span>
            </div>

            <div class="post-actions">
                <div class="left-actions">
                    <button class="action like" aria-label="Me gusta" title="Me gusta" data-likes="${item.likes_count}">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M12 21s-6-3.35-8.5-6.5A5.5 5.5 0 0 1 12 6a5.5 5.5 0 0 1 8.5 8.5C18 17.65 12 21 12 21Z"></path></svg>
                    </button>
                    <button class="action comment" aria-label="Comentar" title="Ver ofertas" data-offers="${item.ofertas_count}">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M21 15a4 4 0 0 1-4 4H8l-5 3 1.5-4.5A4 4 0 0 1 5 6h12a4 4 0 0 1 4 4v5Z"></path></svg>
                    </button>
                    <button class="action share" aria-label="Compartir" title="Compartir">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M22 12 13 5v4C6 9 3 13 2 20c2.5-3.5 6-5 11-5v4l9-7Z"></path></svg>
                    </button>
                </div>
                <div class="right-actions">
                    <button class="offer-btn" data-default="${(parseFloat(item.precio) * 0.75).toFixed(2)}" title="Enviar oferta" data-product-id="${item.id}">Ofertar</button>
                    <button class="action bookmark" aria-label="Guardar" title="Guardar">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M6 3h12v18l-6-3-6 3V3Z"></path></svg>
                    </button>
                </div>
            </div>
            <div class="post-meta">
                <div><b>Descripci√≥n</b> ${item.descripcion}</div>
            </div>
        `;
        return post;
    }

    async function loadProducts(token) {
        const feed = document.getElementById('product-feed');
        const status = document.getElementById('feed-status');
        feed.innerHTML = '';
        status.textContent = 'Cargando productos...';
        feed.appendChild(status);

        try {
            const res = await fetch(API_BASE + ENDPOINT, {
                headers: { 'Authorization': 'Bearer ' + token }
            });

            if (res.status === 401) {
                localStorage.removeItem('token');
                window.location.href = 'login.html';
                return;
            }

            const products = await res.json();
            feed.innerHTML = ''; 
            
            if (products.length === 0) {
                feed.innerHTML = '<p style="text-align:center; color:var(--muted);">No hay productos en venta.</p>';
            } else {
                products.forEach(p => feed.appendChild(createProductCard(p)));
            }

        } catch (err) {
            console.error('Error al cargar productos:', err);
            feed.innerHTML = '<p style="color:red; text-align:center;">Error al cargar la tienda.</p>';
        }
    }

    // --- L√≥gica de Oferta (Backend) ---
    async function submitOffer(productId, amount, token) {
        const offerMsg = document.getElementById('offerMsg');
        offerMsg.className = 'msg';
        offerMsg.textContent = 'Enviando oferta...';

        try {
            const res = await fetch(API_BASE + `${ENDPOINT}/${productId}/ofertas`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({ cantidad: amount })
            });

            const data = await res.json();
            
            if (!res.ok) {
                offerMsg.className = 'msg error';
                offerMsg.textContent = data.error || 'Error al enviar la oferta.';
                return false;
            }

            offerMsg.className = 'msg success';
            offerMsg.textContent = '¬°Oferta enviada correctamente!';
            return true;

        } catch (err) {
            offerMsg.className = 'msg error';
            offerMsg.textContent = 'Error de conexi√≥n con el servidor.';
            return false;
        }
    }


    // --- Interacciones y Modales ---
    const dialog = document.getElementById('offerDialog');
    const offerForm = document.getElementById('offerForm');
    const offerInput = document.getElementById('offerInput');
    const offerItem = document.getElementById('offerItem');
    const cancelOffer = document.getElementById('cancelOffer');
    let lastOfferBtn = null;

    function initOfferModal(token) {
        document.getElementById('product-feed').addEventListener('click', (e) => {
            const btn = e.target.closest('.offer-btn');
            if (!btn) return;
            
            lastOfferBtn = btn;
            currentProductId = btn.dataset.productId;

            const article = btn.closest('.post');
            const itemName = article?.querySelector('.item-name')?.textContent || 'Art√≠culo';
            
            const priceText = article?.querySelector('.item-price')?.textContent;
            let originalPrice = 0;
            if (priceText) {
                const cleanedPrice = priceText.replace('PVP:', '').replace('‚Ç¨', '').trim().replace(',', '.');
                originalPrice = parseFloat(cleanedPrice);
            }
            const def = (originalPrice * 0.75).toFixed(2);


            offerItem.textContent = itemName;
            offerInput.value = def > 0 ? def : '0.10'; 
            document.getElementById('offerMsg').textContent = ''; 

            if (typeof dialog.showModal === 'function') {
                dialog.showModal();
            }
            offerInput.focus();
            offerInput.select();
        });

        offerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const amount = parseFloat(offerInput.value);

            if (isNaN(amount) || amount < 0.10) {
                offerInput.focus();
                return;
            }

            const success = await submitOffer(currentProductId, amount, token);
            
            if (success && lastOfferBtn) {
                lastOfferBtn.textContent = `Ofertado ${amount.toFixed(2)} ‚Ç¨`;
                lastOfferBtn.classList.add('offered');
                lastOfferBtn.setAttribute('aria-label', `Oferta enviada de ${amount.toFixed(2)} euros`);
                setTimeout(() => dialog.close(), 1500); 
            } else if (success) {
                 setTimeout(() => dialog.close(), 1500);
            }
        });

        cancelOffer.addEventListener('click', () => dialog.close());
    }


    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        applyThemePreference(); 

        const token = getTokenOrRedirect();
        if (!token) return;

        loadProducts(token);
        initOfferModal(token);

        document.getElementById('product-feed').addEventListener('click', (e) => {
            const btn = e.target.closest('.action.comment');
            if (!btn) return;
            alert('Cargar modal de ofertas recibidas (Pendiente de implementar).');
        });

        document.getElementById('product-feed').addEventListener('click', (e) => {
            const btn = e.target.closest('.action:not(.comment)');
            if (!btn) return;

            const action = btn.getAttribute('aria-label');
            if (action === 'Me gusta' || action === 'Guardar') {
                btn.classList.toggle('active');
            }
        });
    });
  </script>
</body>
</html>