<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ConoCEU · Usuario</title>
  <link rel="stylesheet" href="css/perfil.css" /> 
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Gochi+Hand&display=swap" rel="stylesheet">
</head>
<body>
  <div class="app-frame">
    <header class="topbar">
      <div class="window-dots">
        <span></span><span></span><span></span>
      </div>

      <a href="index.html" class="brand">
        <span class="brand-primary">Cono</span><span class="brand-accent">CEU</span>
      </a>

      <div class="top-actions">
        <a href="Chats.html" class="icon-btn" aria-label="Chats" title="Chats">
          <img src="img/Chats.png" alt="" class="icon">
        </a>
        <a href="Notificaciones.html" class="icon-btn" aria-label="Notificaciones" title="Notificaciones">
          <img src="img/Campanita.png" alt="" class="icon">
        </a>
        <a href="Perfil.html" class="icon-btn" aria-label="Perfil" title="Perfil">
          <img src="img/Perfil.png" alt="" class="icon">
        </a>
      </div>
    </header>

    <div class="page-title" id="page-title">Perfil de usuario</div>

    <main class="layout">
      <aside class="col-side">
        <div class="ad video-container">
          <video
            src="anuncios/AnuncioAdidas.mp4"
            autoplay
            muted
            loop
            playsinline
            preload="auto"
            controlslist="nodownload noplaybackrate"
            disablepictureinpicture
            oncontextmenu="return false;"
          ></video>
        </div>
      </aside>

      <section class="col-center">
        <div class="card profile-header">
          <div class="avatar" id="profile-avatar">
            <span id="profile-avatar-initials">CEU</span>
          </div>

          <div class="profile-meta">
            <h2 id="profile-fullname">Cargando...</h2>
            <p class="subtitle" id="profile-subtitle">—</p>

            </div>
        </div>

        <section class="card profile-info">
          <h3>Información pública</h3>
          <dl class="info-grid">
            <div>
              <dt>Usuario</dt>
              <dd id="info-username">@usuario</dd>
            </div>
            <div>
              <dt>Nombre completo</dt>
              <dd id="info-name">—</dd>
            </div>
            <div>
              <dt>Grado</dt>
              <dd id="info-degree">—</dd>
            </div>
            <div>
              <dt>Curso</dt>
              <dd id="info-year">—</dd>
            </div>
            <div>
              <dt>País</dt>
              <dd id="info-country">—</dd>
            </div>
            <div>
              <dt>Ciudad</dt>
              <dd id="info-city">—</dd>
            </div>
            <div>
              <dt>Fecha de nacimiento</dt>
              <dd id="info-birthdate">—</dd>
            </div>
          </dl>

          <div class="intereses" id="interests-section">
            <h4>Intereses</h4>
            <div class="chips" id="profile-interests">
              </div>
          </div>
        </section>
      </section>

      <aside class="col-side">
        <div class="ad video-container">
          <video
            src="anuncios/AnuncioAdidas.mp4"
            autoplay
            muted
            loop
            playsinline
            preload="auto"
            controlslist="nodownload noplaybackrate"
            disablepictureinpicture
            oncontextmenu="return false;"
          ></video>
        </div>
      </aside>
    </main>
    
    </div>

  <script>
    const API_BASE = 'https://conoceu-backend.onrender.com';

    function applyThemePreference(prefFromStorage) {
        const pref = prefFromStorage || localStorage.getItem('cfg_theme') || 'system';
        function setTheme(theme) { document.documentElement.dataset.theme = theme; }
        if (pref === 'system') {
            const mq = window.matchMedia('(prefers-color-scheme: dark)');
            setTheme(mq.matches ? 'dark' : 'light');
            mq.addEventListener('change', e => {
                const current = localStorage.getItem('cfg_theme') || 'system';
                if (current === 'system') { setTheme(e.matches ? 'dark' : 'light'); }
            });
        } else { setTheme(pref); }
    }
    applyThemePreference(); 

    function getToken() {
        return localStorage.getItem('token');
    }

    function redirectToLogin() {
        window.location.href = 'login.html';
    }

    function formatearFecha(fechaISO) {
        if (!fechaISO) return '—';
        const d = new Date(fechaISO);
        if (isNaN(d.getTime())) return fechaISO;
        return d.toLocaleDateString('es-ES');
    }

    function setAvatarFromName(fullName) {
        const initialsSpan = document.getElementById('profile-avatar-initials');
        if (!fullName) {
            initialsSpan.textContent = 'CEU';
            return;
        }
        const parts = fullName.trim().split(/\s+/);
        let initials = parts[0].charAt(0);
        if (parts.length > 1) {
            initials += parts[parts.length - 1].charAt(0);
        }
        initialsSpan.textContent = initials.toUpperCase();
    }

    async function cargarInfoUsuario() {
        const token = getToken();
        if (!token) return redirectToLogin();
        
        // Obtener el ID del usuario de la URL: ?id=XXX
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('id');

        if (!userId) {
            document.getElementById('page-title').textContent = 'Error: ID de usuario no proporcionado.';
            return;
        }

        try {
            const res = await fetch(`${API_BASE}/api/users/${userId}`, {
                method: 'GET',
                headers: { 'Authorization': 'Bearer ' + token }
            });

            if (res.status === 404) {
                 document.getElementById('page-title').textContent = 'Usuario no encontrado.';
                 return;
            }
            if (!res.ok) throw new Error('Error al cargar datos.');
            
            const user = await res.json();
            
            const fullName = ((user.nombre || '') + ' ' + (user.apellido || '')).trim() || user.username || 'Usuario';
            
            // Título de la página
            document.getElementById('page-title').textContent = 'Perfil de ' + fullName;
            
            // Cabecera
            document.getElementById('profile-fullname').textContent = fullName;
            
            const subtitleParts = [];
            if (user.grado) subtitleParts.push(user.grado);
            if (user.ciudad) subtitleParts.push(user.ciudad);
            if (user.pais) subtitleParts.push(user.pais);
            document.getElementById('profile-subtitle').textContent =
                subtitleParts.length ? subtitleParts.join(' · ') : 'Estudiante CEU';

            setAvatarFromName(fullName);

            // Información
            document.getElementById('info-username').textContent = user.username ? '@' + user.username : '—';
            document.getElementById('info-name').textContent = fullName || '—';
            document.getElementById('info-degree').textContent = user.grado || '—';
            document.getElementById('info-year').textContent = user.curso || '—';
            document.getElementById('info-country').textContent = user.pais || '—';
            document.getElementById('info-city').textContent = user.ciudad || '—';
            document.getElementById('info-birthdate').textContent = formatearFecha(user.fecha_nacimiento);

            // Intereses
            const interestsSection = document.getElementById('interests-section');
            const interestsContainer = document.getElementById('profile-interests');
            interestsContainer.innerHTML = '';
            
            let intereses = user.intereses;

            if (Array.isArray(intereses) && intereses.length) {
                intereses.forEach(i => {
                    const span = document.createElement('span');
                    span.className = 'chip';
                    span.textContent = i;
                    interestsContainer.appendChild(span);
                });
            } else if (typeof intereses === 'string' && intereses.trim() !== '') {
                intereses.split(',').forEach(i => {
                    const span = document.createElement('span');
                    span.className = 'chip';
                    span.textContent = i.trim();
                    interestsContainer.appendChild(span);
                });
            } else {
                interestsSection.style.display = 'none';
            }

            // Foto de perfil
            if (user.foto_perfil) {
                const avatar = document.getElementById('profile-avatar');
                avatar.style.backgroundImage = 'url(' + user.foto_perfil + ')';
                avatar.style.backgroundSize = 'cover';
                avatar.style.backgroundPosition = 'center';
                avatar.classList.add('avatar-image');
                document.getElementById('profile-avatar-initials').style.display = 'none';
            }

        } catch (err) {
            console.error('Error cargando información de usuario', err);
            document.getElementById('page-title').textContent = 'Error al cargar los datos del usuario.';
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        cargarInfoUsuario();
    });
  </script>
</body>
</html>