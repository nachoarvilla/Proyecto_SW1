<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ConoCEU ‚Äî Buscar Usuarios</title>
  <link rel="stylesheet" href="css/style_chats.css">
</head>
<body class="ch-page">
  <header class="ch-header">
    <a href="index.html" class="ch-brand" aria-label="Ir a inicio">
      <img src="img/logoceu.png" alt="Logo CEU" class="ch-logo">
      <span class="ch-brand-cono">Cono</span><span class="ch-brand-ceu">CEU</span>
    </a>

    <h1 class="ch-title">Buscar Usuarios</h1>

    <nav class="ch-actions" aria-label="Acciones">
      <a class="ch-iconbtn" href="Chats.html" aria-label="Ir a chats">
        <img src="img/Chats.png" alt="" class="ch-icon">
      </a>
      <a class="ch-iconbtn" href="Notificaciones.html" aria-label="Ir a notificaciones">
        <img src="img/Campanita.png" alt="" class="ch-icon">
      </a>
      <a class="ch-iconbtn" href="Perfil.html" aria-label="Ir a perfil">
        <img src="img/Perfil.png" alt="" class="ch-icon">
      </a>
    </nav>
  </header>

  <main class="ch-layout" style="grid-template-columns: 1fr;">
    <section class="ch-panel" aria-label="B√∫squeda de usuario">
      <header class="ch-panel-hd">
        <strong>Buscar usuario por Username</strong>
      </header>
      <form id="search-form" class="ch-input" onsubmit="searchUser(event)">
        <input type="search" id="username-search" placeholder="Escribe un nombre de usuario..." aria-label="Buscar usuario" required>
        <button type="submit">Buscar</button>
      </form>
      
      <div class="ch-thread">
        <p id="search-status" style="text-align: center; color: var(--muted);">Escribe un username y pulsa buscar.</p>
        <div id="results-list" class="ch-list" style="padding: 12px 0;">
          </div>
      </div>
    </section>
  </main>
  
  <script>
    function applyThemePreference(prefFromStorage) {
        const pref = prefFromStorage || localStorage.getItem('cfg_theme') || 'system';

        function setTheme(theme) {
            // Establece el atributo data-theme en la etiqueta <html>
            document.documentElement.dataset.theme = theme;
        }

        if (pref === 'system') {
            const mq = window.matchMedia('(prefers-color-scheme: dark)');
            setTheme(mq.matches ? 'dark' : 'light');
            mq.addEventListener('change', e => {
                const current = localStorage.getItem('cfg_theme') || 'system';
                if (current === 'system') {
                    setTheme(e.matches ? 'dark' : 'light');
                }
            });
        } else {
            setTheme(pref);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
    // Llama a la funci√≥n de aplicaci√≥n del tema.
    applyThemePreference(); 
    });

    // URL base de tu backend
    const BASE_URL = 'https://conoceu-backend.onrender.com';

    // Funci√≥n de utilidad para obtener el token
    function getToken() {
      return localStorage.getItem('token');
    }

    // Crea un bot√≥n de usuario para el resultado de la b√∫squeda
    function createUserItem(user) {
        const button = document.createElement('button');
        button.className = 'ch-item';
        button.innerHTML = `
            <img src="${user.foto_perfil || 'img/Perfil.png'}" alt="" class="ch-item-avatar">
            <span>${user.username} (${user.nombre} ${user.apellido})</span>
        `;
        button.addEventListener('click', () => createChat(user.id, user.username));
        return button;
    }

    // Maneja la b√∫squeda de usuarios
    async function searchUser(event) {
      event.preventDefault();
      const username = document.getElementById('username-search').value.trim();
      const resultsList = document.getElementById('results-list');
      const searchStatus = document.getElementById('search-status');
      resultsList.innerHTML = '';
      searchStatus.textContent = 'Buscando...';

      if (!username) {
        searchStatus.textContent = "Escribe un username y pulsa buscar.";
        return;
      }

      try {
        const response = await fetch(`${BASE_URL}/api/users/search?username=${username}`, {
          headers: { 'Authorization': `Bearer ${getToken()}` }
        });
        
        if (response.status === 401) {
            alert('Sesi√≥n expirada. Por favor, vuelve a iniciar sesi√≥n.');
            window.location.href = 'Login.html'; // Asume que tienes una p√°gina de login
            return;
        }

        const data = await response.json();
        
        // üí° CORRECCI√ìN: Asegurar que 'data' es un array antes de usar forEach
        if (!response.ok || !Array.isArray(data)) {
            // Si el backend devuelve un error (ej. 400, 500) o un objeto no array.
            const errorMsg = data.error || 'Respuesta de b√∫squeda inv√°lida o error en el servidor.';
            searchStatus.textContent = `Error al buscar: ${errorMsg}`;
            return;
        }

        const users = data; // Ahora sabemos que es un array
        
        if (users.length === 0) {
          searchStatus.textContent = `No se encontraron usuarios con el username "${username}".`;
        } else {
          searchStatus.textContent = `Resultados para "${username}":`;
          users.forEach(user => resultsList.appendChild(createUserItem(user)));
        }

      } catch (error) {
        console.error('Error al buscar usuarios:', error);
        searchStatus.textContent = 'Error al buscar usuarios en el servidor.';
      }
    }

    // Crea el chat privado
    async function createChat(destinatario_id, username) {
        if (!confirm(`¬øQuieres iniciar un chat privado con ${username}?`)) {
            return;
        }

        try {
            const response = await fetch(`${BASE_URL}/api/chats/privado`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getToken()}` 
                },
                body: JSON.stringify({ destinatario_id })
            });

            if (response.ok) {
                const result = await response.json();
                alert(`Chat privado creado con ${username} (ID: ${result.chat_id}).`);
                window.location.href = 'Chats.html'; // Redirige a la p√°gina principal de chats
            } else {
                const error = await response.json();
                alert(`Error creando chat: ${error.error}`);
            }

        } catch (error) {
            console.error('Error al crear el chat:', error);
            alert('Error de conexi√≥n al crear el chat.');
        }
    }
  </script>
</body>
</html>