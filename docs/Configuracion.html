<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ConoCEU · Configuración</title>
  <link rel="stylesheet" href="css/style_configuracion.css" />
</head>
<body>
  <!-- Header -->
  <header class="header">
    <nav class="nav">
      <a class="logo" href="index.html">ConoCEU</a>
      <h1 class="page-title">Configuración</h1>
      <div class="nav-actions">
        <a class="icon-btn" href="Chats.html" title="Mensajes" aria-label="Mensajes">
          <svg class="icon" viewBox="0 0 24 24"><path d="M21 12a8 8 0 0 1-8 8H7l-4 3 1.5-5A8 8 0 1 1 21 12Z"/></svg>
        </a>
        <a class="icon-btn" href="Notificaciones.html" title="Notificaciones" aria-label="Notificaciones">
          <svg class="icon" viewBox="0 0 24 24"><path d="M15 17H4l2-3v-4a6 6 0 1 1 12 0v4l2 3h-5"/></svg>
        </a>
        <a class="icon-btn" href="Perfil.html" title="Perfil" aria-label="Perfil">
          <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="8" r="4"/><path d="M4 21a8 8 0 0 1 16 0"/></svg>
        </a>
      </div>
    </nav>
  </header>

  <!-- Layout -->
  <main class="wrap">
    <section class="panel settings">
      <!-- Tabs -->
      <div class="tabs" role="tablist">
        <button class="tab active" data-tab="perfil" role="tab" aria-selected="true">Perfil</button>
        <button class="tab" data-tab="seguridad" role="tab">Seguridad y privacidad</button>
        <button class="tab" data-tab="notis" role="tab">Notificaciones</button>
        <button class="tab" data-tab="apariencia" role="tab">Apariencia</button>
        <button class="tab" data-tab="cuenta" role="tab">Cuenta</button>
      </div>

      <!-- Contenido de tabs -->
      <div class="tabpanels">
        <!-- PERFIL -->
        <section class="tabpanel show" id="perfil" role="tabpanel">
          <div class="grid-2 perfil-grid">
            <!-- FOTO PERFIL + URL -->
            <div>
              <label class="label">Foto de perfil</label>
              <div class="avatar-row">
                <img id="avatarPreview" class="avatar" src="img/avatar_placeholder.png" alt="Avatar" />
              </div>
              <label class="label" for="foto_perfil">URL de la foto</label>
              <input id="foto_perfil" class="input" type="url" placeholder="https://..." />
              <small class="muted">Introduce la URL de tu foto (por ejemplo, de tu almacenamiento o redes).</small>
            </div>

            <!-- NOMBRE / APELLIDO -->
            <div>
              <label class="label">Nombre</label>
              <input id="nombre" class="input" type="text" placeholder="Nombre" />

              <label class="label" style="margin-top:10px;">Apellido</label>
              <input id="apellido" class="input" type="text" placeholder="Apellidos" />
            </div>

            <!-- GRADO / CURSO / EDAD -->
            <div>
              <label class="label">Grado</label>
              <input id="grado" class="input" type="text" placeholder="Ing. Sistemas de Información" />

              <label class="label" style="margin-top:10px;">Curso</label>
              <input id="curso" class="input" type="text" placeholder="1º, 2º, 3º..." />

              <label class="label" style="margin-top:10px;">Edad</label>
              <input id="edad" class="input" type="number" min="16" max="99" placeholder="Edad" />
            </div>

            <!-- FECHA / CIUDAD / PAÍS -->
            <div>
              <label class="label">Fecha de nacimiento</label>
              <input id="fecha_nacimiento" class="input" type="date" />

              <label class="label" style="margin-top:10px;">Ciudad</label>
              <input id="ciudad" class="input" type="text" placeholder="Madrid" />

              <label class="label" style="margin-top:10px;">País</label>
              <input id="pais" class="input" type="text" placeholder="España" />
            </div>
          </div>

          <div class="actions">
            <button id="savePerfil" class="primary">Guardar perfil</button>
            <span id="perfilMsg" class="msg"></span>
          </div>
        </section>

        <!-- SEGURIDAD Y PRIVACIDAD -->
        <section class="tabpanel" id="seguridad" role="tabpanel">
          <div class="grid-2">
            <div>
              <label class="label">Contraseña actual</label>
              <input id="currentPassword" class="input" type="password" placeholder="Tu contraseña actual" />
            </div>

            <div></div>

            <div>
              <label class="label">Nueva contraseña</label>
              <input id="newPassword1" class="input" type="password" placeholder="••••••••" />
              <div class="meter"><div id="meterBar"></div></div>
              <small class="muted">Usa mayúsculas, minúsculas, números y símbolos.</small>
            </div>

            <div>
              <label class="label">Repite la nueva contraseña</label>
              <input id="newPassword2" class="input" type="password" placeholder="••••••••" />
              <small id="passMsg" class="msg"></small>
            </div>
          </div>

          <div class="actions">
            <button id="saveSecurity" class="primary">Cambiar contraseña</button>
            <span id="secMsg" class="msg"></span>
          </div>
        </section>

        <!-- NOTIFICACIONES (placeholder, sin lógica) -->
        <section class="tabpanel" id="notis" role="tabpanel">
          <p class="muted">
            Las notificaciones aún no están implementadas. Cuando estén disponibles,
            podrás configurar aquí cómo quieres recibirlas.
          </p>
        </section>

        <!-- APARIENCIA -->
        <section class="tabpanel" id="apariencia" role="tabpanel">
          <div class="list">
            <label class="radio">
              <input type="radio" name="theme" value="light" /> Tema claro
            </label>
            <label class="radio">
              <input type="radio" name="theme" value="dark" /> Tema oscuro
            </label>
            <label class="radio">
              <input type="radio" name="theme" value="system" /> Seguir sistema
            </label>
          </div>
          <div class="actions">
            <button id="saveTheme" class="primary">Guardar apariencia</button>
            <span id="themeMsg" class="msg"></span>
          </div>
        </section>

        <!-- CUENTA -->
        <section class="tabpanel" id="cuenta" role="tabpanel">
          <div class="card">
            <h4>Eliminar cuenta</h4>
            <p class="muted">
              Esta acción es irreversible. Se eliminarán tus datos y publicaciones asociadas a tu cuenta.
            </p>
            <div class="row">
              <input id="deletePassword" class="input small" type="password" placeholder="Tu contraseña" />
              <button id="deleteBtn" class="danger">Eliminar cuenta</button>
            </div>
          </div>
          <div class="actions">
            <span id="delMsg" class="msg"></span>
          </div>
        </section>
      </div>
    </section>
  </main>

  <script>
    const API_BASE = 'https://conoceu-backend.onrender.com';

    const $ = (s, p=document) => p.querySelector(s);
    const $$ = (s, p=document) => [...p.querySelectorAll(s)];

    /* ===================== TEMA GLOBAL ===================== */
    function applyThemePreference(prefFromStorage) {
      const pref = prefFromStorage || localStorage.getItem('cfg_theme') || 'system';

      function setTheme(theme) {
        document.documentElement.dataset.theme = theme;
      }

      if (pref === 'system') {
        const mq = window.matchMedia('(prefers-color-scheme: dark)');
        setTheme(mq.matches ? 'dark' : 'light');
        mq.addEventListener('change', e => {
          const current = localStorage.getItem('cfg_theme') || 'system';
          if (current === 'system') {
            setTheme(e.matches ? 'dark' : 'light');
          }
        });
      } else {
        setTheme(pref);
      }
    }

    /* ===================== AUTENTICACIÓN ===================== */
    function getTokenOrRedirect() {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = 'login.html';
        return null;
      }
      return token;
    }

    /* ===================== TABS ===================== */
    function initTabs() {
      $$('.tab').forEach(t => t.addEventListener('click', () => {
        $$('.tab').forEach(b => b.classList.remove('active'));
        t.classList.add('active');
        const id = t.dataset.tab;
        $$('.tabpanel').forEach(tp => tp.classList.toggle('show', tp.id === id));
        history.replaceState(null, '', `#${id}`);
      }));

      const hash = location.hash.replace('#','');
      const btn = hash && $(`.tab[data-tab="${hash}"]`);
      if (btn) btn.click();
    }

    /* ===================== PERFIL ===================== */
    async function loadProfile(token) {
      try {
        const res = await fetch(API_BASE + '/api/profile', {
          headers: { 'Authorization': 'Bearer ' + token }
        });

        if (!res.ok) {
          if (res.status === 401) {
            localStorage.removeItem('token');
            window.location.href = 'login.html';
            return;
          }
          throw new Error('Error al cargar el perfil');
        }

        const user = await res.json();

        $('#nombre').value = user.nombre || '';
        $('#apellido').value = user.apellido || '';
        $('#grado').value = user.grado || '';
        $('#curso').value = user.curso || '';
        $('#edad').value = user.edad || '';
        $('#fecha_nacimiento').value = user.fecha_nacimiento
          ? new Date(user.fecha_nacimiento).toISOString().substring(0,10)
          : '';
        $('#ciudad').value = user.ciudad || '';
        $('#pais').value = user.pais || '';
        $('#foto_perfil').value = user.foto_perfil || '';

        if (user.foto_perfil) {
          $('#avatarPreview').src = user.foto_perfil;
        }
      } catch (err) {
        console.error(err);
        $('#perfilMsg').textContent = 'No se ha podido cargar tu perfil.';
      }
    }

    function initPerfil(token) {
      $('#foto_perfil').addEventListener('input', () => {
        const url = $('#foto_perfil').value.trim();
        if (url) $('#avatarPreview').src = url;
      });

      $('#savePerfil').addEventListener('click', async () => {
        const payload = {
          nombre: $('#nombre').value.trim(),
          apellido: $('#apellido').value.trim(),
          grado: $('#grado').value.trim(),
          curso: $('#curso').value.trim(),
          edad: $('#edad').value ? Number($('#edad').value) : null,
          fecha_nacimiento: $('#fecha_nacimiento').value || null,
          ciudad: $('#ciudad').value.trim(),
          pais: $('#pais').value.trim(),
          foto_perfil: $('#foto_perfil').value.trim() || null,
        };

        if (!payload.nombre || !payload.apellido) {
          $('#perfilMsg').textContent = 'Nombre y apellido son obligatorios.';
          return;
        }

        try {
          const res = await fetch(API_BASE + '/api/profile', {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify(payload)
          });

          const data = await res.json().catch(() => ({}));

          if (!res.ok) {
            $('#perfilMsg').textContent = data.error || 'Error al guardar el perfil.';
            return;
          }

          $('#perfilMsg').textContent = 'Perfil actualizado correctamente.';
          setTimeout(() => $('#perfilMsg').textContent = '', 2000);
        } catch (err) {
          console.error(err);
          $('#perfilMsg').textContent = 'Error de conexión con el servidor.';
        }
      });
    }

    /* ===================== SEGURIDAD ===================== */
    function passwordStrength(v) {
      let s = 0;
      if (v.length >= 8) s++;
      if (/[A-Z]/.test(v)) s++;
      if (/[a-z]/.test(v)) s++;
      if (/[0-9]/.test(v)) s++;
      if (/[^A-Za-z0-9]/.test(v)) s++;
      return Math.min(s, 5);
    }

    function initSecurity(token) {
      $('#newPassword1').addEventListener('input', e => {
        const s = passwordStrength(e.target.value);
        const w = (s / 5) * 100;
        const bar = $('#meterBar');
        bar.style.width = w + '%';
        bar.dataset.level = s;
      });

      $('#saveSecurity').addEventListener('click', async () => {
        const currentPassword = $('#currentPassword').value;
        const newPassword1 = $('#newPassword1').value;
        const newPassword2 = $('#newPassword2').value;

        $('#passMsg').textContent = '';
        $('#secMsg').textContent = '';

        if (!currentPassword || !newPassword1 || !newPassword2) {
          $('#passMsg').textContent = 'Rellena todos los campos.';
          return;
        }
        if (newPassword1 !== newPassword2) {
          $('#passMsg').textContent = 'Las contraseñas nuevas no coinciden.';
          return;
        }
        if (passwordStrength(newPassword1) < 3) {
          $('#passMsg').textContent = 'La nueva contraseña es demasiado débil.';
          return;
        }

        try {
          const res = await fetch(API_BASE + '/api/change-password', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({
              currentPassword,
              newPassword: newPassword1
            })
          });

          const data = await res.json().catch(() => ({}));
          if (!res.ok) {
            $('#passMsg').textContent = data.error || 'No se ha podido cambiar la contraseña.';
            return;
          }

          $('#secMsg').textContent = 'Contraseña actualizada correctamente.';
          $('#currentPassword').value = '';
          $('#newPassword1').value = '';
          $('#newPassword2').value = '';
          $('#meterBar').style.width = '0%';
          setTimeout(() => $('#secMsg').textContent = '', 2000);
        } catch (err) {
          console.error(err);
          $('#secMsg').textContent = 'Error de conexión con el servidor.';
        }
      });
    }

    /* ===================== APARIENCIA ===================== */
    function initTheme() {
      // cargar tema guardado
      const stored = localStorage.getItem('cfg_theme') || 'system';
      const radio = document.querySelector(`input[name="theme"][value="${stored}"]`);
      if (radio) radio.checked = true;
      applyThemePreference(stored);

      $('#saveTheme').addEventListener('click', () => {
        const selected = document.querySelector('input[name="theme"]:checked')?.value || 'system';
        localStorage.setItem('cfg_theme', selected);
        applyThemePreference(selected);
        $('#themeMsg').textContent = 'Tema aplicado.';
        setTimeout(() => $('#themeMsg').textContent = '', 2000);
      });
    }

    /* ===================== CUENTA ===================== */
    function initDeleteAccount(token) {
      $('#deleteBtn').addEventListener('click', async () => {
        const password = $('#deletePassword').value;
        $('#delMsg').textContent = '';

        if (!password) {
          $('#delMsg').textContent = 'Introduce tu contraseña para eliminar la cuenta.';
          return;
        }

        const ok = confirm('¿Seguro que quieres eliminar tu cuenta? Esta acción no se puede deshacer.');
        if (!ok) return;

        try {
          const res = await fetch(API_BASE + '/api/account', {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({ password })
          });

          const data = await res.json().catch(() => ({}));

          if (!res.ok) {
            $('#delMsg').textContent = data.error || 'No se ha podido eliminar la cuenta.';
            return;
          }

          // éxito: limpiamos sesión
          localStorage.removeItem('token');
          alert('Tu cuenta ha sido eliminada.');
          window.location.href = 'index.html';
        } catch (err) {
          console.error(err);
          $('#delMsg').textContent = 'Error de conexión con el servidor.';
        }
      });
    }

    /* ===================== INIT ===================== */
    document.addEventListener('DOMContentLoaded', () => {
      applyThemePreference();
      initTabs();

      const token = getTokenOrRedirect();
      if (!token) return;

      loadProfile(token);
      initPerfil(token);
      initSecurity(token);
      initTheme();
      initDeleteAccount(token);
    });
  </script>
</body>
</html>
