<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ConoCEU ¬∑ Vender Material ExtraEscolar</title>
  <link rel="stylesheet" href="css/style_tienda_extraescolar.css" />
  <link rel="stylesheet" href="css/style_chats.css">
</head>
<body>
  <header class="ch-header">
    <a href="index.html" class="ch-brand" aria-label="Ir a inicio">
      <span class="ch-brand-cono">Cono</span><span class="ch-brand-ceu">CEU</span>
    </a>
    <div class="nav-center" onclick="location.reload()">
      <img src="img/logoceu.png" alt="Logo CEU" class="ch-logo">
    </div>
    <nav class="ch-actions" aria-label="Acciones">
      <a class="ch-iconbtn" aria-label="Chats" href="Chats.html">
        <img src="img/Chats.png" alt="" class="ch-icon">
      </a>
      <a class="ch-iconbtn" href="Notificaciones.html" aria-label="Ir a notificaciones">
        <img src="img/Campanita.png" alt="" class="ch-icon">
      </a>
      <a class="ch-iconbtn" href="Perfil.html" aria-label="Ir a perfil">
        <img src="img/Perfil.png" alt="" class="ch-icon">
      </a>
    </nav>
  </header>

  <main class="wrap" style="grid-template-columns: 1fr; max-width: 700px;">
    <section class="panel">
      <form id="productForm" class="form-container">
        <h2 style="margin-bottom: 20px;">Publicar producto extraescolar</h2>
        
        <div id="formMsg" class="msg" style="margin-bottom: 15px;"></div>

        <label for="descripcion">Descripci√≥n del producto</label>
        <textarea id="descripcion" name="descripcion" required rows="3" placeholder="Ej: Bal√≥n de f√∫tbol talla 5, marca Nike, poco uso." maxlength="500"></textarea>
        
        <div class="form-row">
          <div>
            <label for="foto">URL de la foto (Obligatorio)</label>
            <input id="foto" name="foto" type="url" placeholder="https://..." required>
            <small class="muted">Sube tu foto a un servicio de almacenamiento y pega la URL.</small>
          </div>
          
          <div>
            <label for="precio">Precio de venta (‚Ç¨)</label>
            <input id="precio" name="precio" type="number" min="0.10" step="0.10" inputmode="decimal" placeholder="Ej: 15.00" required>
          </div>
        </div>
        
        <label for="ubicacion">Ubicaci√≥n (Opcional)</label>
        <input id="ubicacion" name="ubicacion" type="text" placeholder="Ej: Pabell√≥n deportivo">

        <button type="submit" class="offer-btn" style="margin-top: 20px; background: var(--brand); color: white; border: none;">
          Publicar Venta
        </button>
      </form>
    </section>
  </main>

  <script>
    const API_BASE = 'https://conoceu-backend.onrender.com';
    const ENDPOINT = '/api/tienda-extraescolar'; // üí° CAMBIO CLAVE DEL ENDPOINT

    function getTokenOrRedirect() {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = 'login.html';
        return null;
      }
      return token;
    }
    
    // L√≥gica de tema
    function applyThemePreference(prefFromStorage) {
      const pref = prefFromStorage || localStorage.getItem('cfg_theme') || 'system';
      function setTheme(theme) { document.documentElement.dataset.theme = theme; }
      if (pref === 'system') {
        const mq = window.matchMedia('(prefers-color-scheme: dark)');
        setTheme(mq.matches ? 'dark' : 'light');
        mq.addEventListener('change', e => {
          const current = localStorage.getItem('cfg_theme') || 'system';
          if (current === 'system') { setTheme(e.matches ? 'dark' : 'light'); }
        });
      } else { setTheme(pref); }
    }
    applyThemePreference(); 
    
    document.addEventListener('DOMContentLoaded', () => {
      const token = getTokenOrRedirect();
      if (!token) return;

      const form = document.getElementById('productForm');
      const formMsg = document.getElementById('formMsg');

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const payload = {
          descripcion: document.getElementById('descripcion').value.trim(),
          foto: document.getElementById('foto').value.trim(),
          precio: parseFloat(document.getElementById('precio').value),
          ubicacion: document.getElementById('ubicacion').value.trim() || null,
        };

        if (!payload.foto || isNaN(payload.precio)) {
          formMsg.textContent = 'Por favor, completa la URL de la foto y el precio.';
          return;
        }

        formMsg.textContent = 'Publicando...';
        
        try {
          const res = await fetch(API_BASE + ENDPOINT, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify(payload)
          });
          
          const data = await res.json();

          if (!res.ok) {
            formMsg.className = 'msg error';
            formMsg.textContent = data.error || 'Error al publicar el producto.';
            return;
          }

          formMsg.className = 'msg success';
          formMsg.textContent = '¬°Producto publicado correctamente! Redirigiendo...';
          setTimeout(() => {
            window.location.href = 'TiendaExtraescolar.html';
          }, 1500);

        } catch (err) {
          console.error(err);
          formMsg.className = 'msg error';
          formMsg.textContent = 'Error de conexi√≥n con el servidor.';
        }
      });
    });
  </script>
</body>
</html>